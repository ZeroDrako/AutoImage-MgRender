// ==UserScript==
// @name          ZD AutoImage MgRender
// @namespace     https://github.com/ZeroDrako/AutoImage-MgRender
// @version       3.0
// @description   Automatic download HD-Images from MG-Render to download folder
// @author        ZeroDrako
// @license       GPLv3; https://github.com/ZeroDrako/AutoImage-MgRender/blob/master/LICENSE
// @updateURL     https://raw.githubusercontent.com/ZeroDrako/AutoImage-MgRender/master/ZD%20AutoImage%20MgRender.js
// @downloadURL   https://raw.githubusercontent.com/ZeroDrako/AutoImage-MgRender/master/ZD%20AutoImage%20MgRender.js
// @include       *mg-renders.net*
// @grant         GM_addStyle
// @grant         window.close
// @grant         GM_getValue
// @grant         GM_setValue
// @grant         GM_xmlhttpRequest
// @noframes
// @require       https://raw.githubusercontent.com/eligrey/FileSaver.js/master/FileSaver.min.js
// @require       https://raw.githubusercontent.com/Stuk/jszip/master/dist/jszip.min.js
// @icon          http://i1236.photobucket.com/albums/ff444/ZeroDrako/128_zpstpkixbgq.png
// ==/UserScript==

"use strict";function loadPreferences(){try{document.getElementById("ZDautodown").value=GM_getValue("AutoDownload",!1),document.getElementById("ZDshowurl").value=GM_getValue("ShowUrl",!1),document.getElementById("ZDautoclose").value=GM_getValue("AutoClose",!1),document.getElementById("ZDalertdialog").value=GM_getValue("ArtDialog",!1),document.getElementById("ZDzipgallery").value=GM_getValue("ZipGallery",!1),document.getElementById("ZDautopage").value=GM_getValue("AutoPageGallery",!1),document.getElementById("ZDnumfiles").innerHTML=stringToFiles(GM_getValue("Files","")).length}catch(e){console.log(e.message)}downFiles=stringToFiles(GM_getValue("Files",""))}function addSettingPanel(){function e(e){function t(){l=document.getElementById("ZDsaved").innerHTML=e}function o(){l=document.getElementById("ZDsaved").innerHTML="&nbsp;"}var l;setTimeout(t,100),setTimeout(o,200),setTimeout(t,300),setTimeout(o,400),setTimeout(t,500),setTimeout(o,1500)}var t="#ZDtitle,.ZDoption{color:#989c9f !important}#popup{border:0px solid #21262a;background-color:#000;text-align:center}#ZDtitle{font-family:Play;font-size:20px;padding-top:20px}.ZDoption{font-size:16px}#ZDautodown,#ZDautoclose,#ZDzipgallery,#ZDautopage,#ZDalertdialog,#ZDdirhelp,#ZDsave,#ZDshowurl{font-size:12px;font-weight:400;opacity:.7;float:right !important;color:#fff;border:0px solid #3a434a;background:#3a434a}#ZDdirectory{color:#666;border:1px solid #202529;background:#000}",o=document.createElement("style");o.type="text/css",o.id="ZDStyle",o.innerHTML=t,document.head.appendChild(o);var l=document.createElement("div");l.id="ZDpopup",document.getElementById("HTML5").remove(),document.getElementById("PlusOne1").remove(),l.innerHTML='<div id=ZDtitle class=ZDtitle> <h4>ZD AutoImage MgRender v3</h4> </div> <div class=wrap> <form id=translateForm> <div> <h5 class=ZDoption>Auto Down? <select id=ZDautodown> <option value=false>No</option> <option value=true>Yes</option> </select> <br>Show URLs? <select id=ZDshowurl> <option value=false>No</option> <option value=true>Yes</option> </select> <br>Close Wind? <select id=ZDautoclose> <option value=false>No</option> <option value=true>Yes</option> </select> <br>Alert Dial? <select id=ZDalertdialog> <option value=false>No</option> <option value=true>Yes</option> </select> <br>Zip Gallery? <select id=ZDzipgallery> <option value=false>No</option> <option value=true>Yes</option> </select> <br>Auto Page? <select id=ZDautopage> <option value=false>No</option> <option value=true>Yes</option> </select> <br>Files: <h7 id=ZDnumfiles></h7> <input id=ZDdirselect type=file multiple webkitdirectory directory style="display: none;"> <input type=button id=ZDdirhelp value=Browse... onclick="document.getElementById(\'ZDdirselect\').click()"> </h5> </div> <p id=ZDsaved class=ZDoption>&nbsp;</p> </form> </div>',document.getElementById("Label1").appendChild(l),l.addEventListener("change",function(t){switch(t.target.id){case"ZDautodown":GM_setValue("AutoDownload","true"===document.getElementById("ZDautodown").value?!0:!1),e("Saved!!!");break;case"ZDshowurl":GM_setValue("ShowUrl","true"===document.getElementById("ZDshowurl").value?!0:!1),e("Saved!!!");break;case"ZDautoclose":GM_setValue("AutoClose","true"===document.getElementById("ZDautoclose").value?!0:!1),e("Saved!!!");break;case"ZDzipgallery":GM_setValue("ZipGallery","true"===document.getElementById("ZDzipgallery").value?!0:!1),e("Saved!!!");break;case"ZDautopage":GM_setValue("AutoPageGallery","true"===document.getElementById("ZDautopage").value?!0:!1),e("Saved!!!");break;case"ZDalertdialog":GM_setValue("ArtDialog","true"===document.getElementById("ZDalertdialog").value?!0:!1),e("Saved!!!");break;case"ZDdirselect":var o=t.target.files;if(0!==o.length){for(var l,n=0,a=[];l=o[n];n++)a.push(l.name);GM_setValue("Files",filesToString(a)),document.getElementById("ZDnumfiles").innerHTML=stringToFiles(GM_getValue("Files","")).length,e("Saved!!!")}break;default:e("Canceled!!!")}})}function addProgressBar(){var e;e=-1!==url.indexOf("hentai")?"entry-title":"mtitle";for(var t=document.getElementsByClassName(e),o=0;o<t.length;o++){var l=document.createElement("PROGRESS"),n=document.createElement("BR");l.setAttribute("value","0"),l.setAttribute("max","100"),l.setAttribute("id","ZdBar"+o),l.setAttribute("class","ZdBar"),t[o].appendChild(l),t[o].appendChild(n)}}function getLink(){var e=document.getElementById("size-o").getElementsByTagName("a"),t=e[0].href;if(t.indexOf("/s0/")>=0||/\/s(\d+)-.+\//.test(t)){if(t=t.replace(/\/s(\d+)-.+\//,"/s0/"),-1===t.indexOf("/s0/"))return alert("Algo Salio Mal!!!"),void console.log(t);if(GM_getValue("ShowUrl")&&!GM_getValue("AutoClose"))try{document.getElementById("HTML7").innerHTML=t}catch(o){document.getElementById("size").innerHTML=t}return t}}function getName(e){return decodeURLRecursively(e.substring(e.lastIndexOf("/")+1))}function downloadImage(e,t){if(-1!==downFiles.indexOf(t))GM_getValue("ArtDialog")&&alert("File already Downloaded!!!"),setTimeout(close,1e3);else{var o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="blob",o.onload=function(){if(200===this.status){var e=this.response;saveAs(e,t)}setTimeout(close,1500)},o.onerror=function(e){alert("Error "+e.target.status+" occurred while receiving the document.")},o.send()}}function getGalleryLinks(){var e,t,o;-1!==url.indexOf("hentai")?(e="hentry",t="link",o="href"):(e="mpost",t="meta",o="content");for(var l=document.getElementsByClassName(e),n=0;n<l.length;n++){var a=l[n].getElementsByTagName(t)[0].getAttribute(o);(a.indexOf("/s0/")>=0||/\/s(\d+)(-.+)?\//.test(a))&&(a=a.replace(/\/s(\d+)(-.+)?\//,"/s0/"),-1===a.indexOf("/s0/")?console.log("Algo Salio Mal!!!  "+a):links.push(a))}return links}function getGalleryName(){var e,t,o,l;-1!==url.indexOf("hentai")?(o="status-msg-wrap",l="b"):(o="status-msg-wrap",l="h1");try{e=document.getElementsByClassName(o)[0].getElementsByTagName(l)[0].innerHTML}catch(n){console.log(n),e="Unknown"}try{t=document.getElementsByClassName("showpagePoint")[0].innerHTML}catch(n){console.log(n),t="0"}return e+" - "+t}function downloadGallery(e,t){var o=document.getElementById("ZdBar"+t),l=new XMLHttpRequest;l.open("GET",e,!0),l.responseType="blob",l.onprogress=function(e){e.lengthComputable&&o.setAttribute("value",e.loaded/e.total*100)},l.onreadystatechange=function(){4===l.readyState&&onDownGalleryComplete(l.response)},l.send(null)}function onDownGalleryComplete(e){count<links.length&&blobToBase64(e,function(e){var t=getName(links[count]);if(zip.file(t,e,{base64:!0}),count<links.length-1)count++,downloadGallery(links[count],count);else try{zip.generateAsync({type:"blob"}).then(function(e){try{saveAs(e,getGalleryName()+".zip"),setTimeout(autoPageChange,1500)}catch(t){console.log(t)}})}catch(o){console.log(o)}})}function autoPageChange(){if(GM_getValue("AutoPageGallery")){var e,t;try{t=document.getElementsByClassName("showpageNum"),e=t[t.length-1].getElementsByTagName("a")[0],"Next"===e.innerHTML?e.click():console.log("Ultima Pagina!!!")}catch(o){console.log(o)}}}function decodeURLRecursively(e){return-1!==e.indexOf("%")?decodeURLRecursively(decodeURIComponent(e)):-1!==e.indexOf("+")?decodeURLRecursively(e.replace("+"," ")):e}function filesToString(e){for(var t=0,o="";t<e.length;t++)o+=e[t]+(t===e.length-1?"":"\\");return o}function stringToFiles(e){return downFiles=[],downFiles=e.split("\\")}function blobToBase64(e,t){var o=new FileReader;o.onload=function(){var e=o.result,l=e.split(",")[1];t(l)},o.readAsDataURL(e)}function close(){GM_getValue("AutoClose")&&window.close()}function master(){if(/\/\d+\/\d+\//.test(url)){GM_getValue("AutoClose")||addSettingPanel(),loadPreferences();var e=getLink(),t=getName(e);GM_getValue("AutoDownload")&&downloadImage(e,t)}else/search\/label/.test(url)?(addSettingPanel(),loadPreferences(),GM_getValue("ZipGallery")&&(addProgressBar(),links=getGalleryLinks(),downloadGallery(links[count],count))):(addSettingPanel(),loadPreferences())}var downFiles=[],links=[],count=0,url=window.location.href,zip=new JSZip;master();
